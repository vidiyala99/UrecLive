<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UREC Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Teko', sans-serif;
            background-color: #101010;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231a1a1a' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #E5E7EB;
        }
        .urec-title {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 3px;
        }
        .urec-gradient-text {
            background: linear-gradient(90deg, #FDE047, #FBBF24, #F59E0B);
            -webkit-background-clip: text;
            color: transparent;
        }
        .card {
            background-color: rgba(24, 24, 27, 0.8);
            border: 1px solid #3f3f46;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .btn-primary {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
            font-size: 1.25rem;
            background: #FDE047;
            color: #18181b;
            border-radius: 6px;
            padding: 10px 20px;
            transition: all 0.2s ease;
            box-shadow: 0 0 15px rgba(253, 224, 71, 0.3);
        }
        .btn-primary:hover {
            background: #FEF08A;
            box-shadow: 0 0 25px rgba(253, 224, 71, 0.5);
            transform: translateY(-2px);
        }
         .btn-primary:disabled {
            background: #3f3f46;
            color: #71717a;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-secondary {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
            background: #DC2626;
            color: white;
            border-radius: 6px;
            padding: 10px 20px;
            transition: all 0.2s ease-in-out;
             box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }
        .btn-secondary:hover {
            background: #EF4444;
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.6);
        }
        .input-field {
            background-color: #18181b;
            border: 2px solid #3f3f46;
            border-radius: 6px;
            color: white;
            font-size: 1.25rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #FDE047;
            box-shadow: 0 0 0 2px rgba(253, 224, 71, 0.5);
        }
        .loader {
            border: 5px solid #3f3f46;
            border-top: 5px solid #FDE047;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-scroll-container::-webkit-scrollbar {
            height: 12px;
        }
        .chart-scroll-container::-webkit-scrollbar-track {
            background: #18181b;
            border-radius: 6px;
        }
        .chart-scroll-container::-webkit-scrollbar-thumb {
            background: #FDE047;
            border-radius: 6px;
        }
        .chart-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #FEF9C3;
        }
    </style>
</head>
<body class="bg-black">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Configuration ---
        const API_BASE_URL = "http://127.0.0.1:8000";
        const REFRESH_INTERVAL = 10000;

        // --- API Helper ---
        const api = {
            async get(endpoint) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                } catch (error) {
                    console.error(`Error fetching ${endpoint}:`, error);
                    return null;
                }
            },
            async post(endpoint, body) {
                 try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                         const err = await response.json();
                         throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    console.error(`Error posting to ${endpoint}:`, error);
                    throw error;
                }
            }
        };

        // --- Components ---
        const Loader = () => <div className="loader mx-auto my-12"></div>;
        
        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const baseClasses = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-black z-50 font-bold text-lg urec-title tracking-widest';
            const typeClasses = type === 'success' ? 'bg-green-400' : 'bg-red-500';
            
            useEffect(() => {
                const timer = setTimeout(() => onClose(), 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`${baseClasses} ${typeClasses}`}>
                    {message}
                    <button onClick={onClose} className="ml-4 font-extrabold">X</button>
                </div>
            );
        };

        const LoginScreen = ({ setPage, setUser }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setIsLoading(true);
                setTimeout(() => {
                    if (!email || !password) {
                        setError('Please fill in all fields.');
                        setIsLoading(false);
                        return;
                    }
                    setUser({ name: email.split('@')[0], email: email, id: 'mockUserId123' });
                    setPage('dashboard');
                }, 500);
            };
            
            return (
                 <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md p-8 space-y-6 card">
                        <h2 className="urec-title text-7xl font-bold text-center urec-gradient-text">
                            UREC LIVE
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 input-field" />
                            </div>
                            <div>
                                <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 input-field" />
                            </div>
                            {error && <p className="text-red-400 text-lg font-bold">{error}</p>}
                            <div>
                                <button type="submit" disabled={isLoading} className="w-full btn-primary text-2xl py-3">
                                    {isLoading ? '...' : 'ENTER THE ARENA'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const HeatmapGrid = ({ heatmapData, onZoneClick, currentCheckIn }) => {
            const getUtilizationClasses = (data) => {
                const percentage = data.total > 0 ? (data.in_use / data.total) * 100 : 0;
                if (percentage >= 70) return 'border-red-500 bg-red-900/50 hover:border-red-400';
                if (percentage >= 30) return 'border-yellow-500 bg-yellow-900/50 hover:border-yellow-400';
                return 'border-green-500 bg-green-900/50 hover:border-green-400';
            };
            const zones = Object.entries(heatmapData);

            return (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {zones.map(([zone, data]) => {
                        const isCheckedIn = currentCheckIn && currentCheckIn.zone === zone;
                        
                        return (
                            <div
                                key={zone}
                                onClick={() => onZoneClick(zone, null)}
                                className={`p-4 rounded-lg border-2 transition-all duration-300 cursor-pointer text-center flex flex-col justify-center aspect-square ${getUtilizationClasses(data)} ${isCheckedIn ? '!bg-yellow-400 !border-white shadow-2xl scale-105' : ''}`}
                            >
                                <p className="font-semibold capitalize text-2xl tracking-wider">{zone.replace(/_/g, ' ')}</p>
                                <p className={`text-6xl font-extrabold my-1 ${isCheckedIn ? 'text-black' : 'text-white'}`}>
                                    {data.in_use || 0}<span className={`text-4xl ${isCheckedIn ? 'text-zinc-800' : 'text-zinc-400'}`}>/{data.total || 0}</span>
                                </p>
                                <p className={`text-lg font-bold ${isCheckedIn ? 'text-zinc-800' : 'text-zinc-400'}`}>IN USE</p>
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        const HistoricalChart = () => {
            const chartRef = useRef(null);
            
            useEffect(() => {
                const mockHourlyPercentages = [10, 5, 5, 15, 30, 60, 80, 85, 70, 50, 45, 55, 60, 50, 65, 80, 95, 98, 85, 70, 50, 40, 30, 20];
                const now = new Date();
                const currentHour = now.getHours();
                const dataForChart = [...mockHourlyPercentages.slice(currentHour + 1), ...mockHourlyPercentages.slice(0, currentHour + 1)];
                const labelsForChart = Array.from({length: 24}, (_, i) => {
                    const d = new Date();
                    d.setHours(now.getHours() - (23 - i));
                    return d.toLocaleString('en-US', { hour: 'numeric', hour12: true });
                });

                const ctx = chartRef.current.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(253, 224, 71, 0.5)');
                gradient.addColorStop(1, 'rgba(253, 224, 71, 0.05)');

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labelsForChart,
                        datasets: [{
                            label: 'Gym Occupancy %',
                            data: dataForChart,
                            borderColor: '#FDE047',
                            backgroundColor: gradient,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#101010',
                            pointBorderColor: '#FDE047',
                            pointHoverRadius: 7,
                            pointBorderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { color: '#a1a1aa', font: { size: 14, family: "'Teko', sans-serif" } } },
                            x: { ticks: { color: '#a1a1aa', font: { size: 14, family: "'Teko', sans-serif" } } }
                        }
                    }
                });
                return () => chart.destroy();
            }, []);

            return <canvas ref={chartRef}></canvas>;
        };

        const CurrentStatus = ({ currentCheckIn, handleCheckOut, activeWorkout }) => {
            if (!currentCheckIn) {
                return (
                    <div className="card p-6 text-center">
                        <p className="font-bold text-yellow-400 text-3xl urec-title tracking-widest">READY TO LIFT</p>
                        <p className="text-xl text-zinc-400">SELECT A ZONE TO BEGIN YOUR SESSION</p>
                    </div>
                );
            }
            const zone = currentCheckIn.zone || currentCheckIn.equipment_type;
            const eqId = currentCheckIn.equipment_id;
            return (
                 <div className="card p-6 text-center">
                    <h3 className="urec-title text-3xl urec-gradient-text">CURRENT SESSION</h3>
                    <p className="mt-2 text-2xl">CHECKED INTO:</p>
                    <p className="font-bold text-5xl capitalize tracking-wide text-white">{zone.replace(/_/g, ' ')}</p>
                     {activeWorkout && <p className="text-yellow-400 font-bold text-2xl">DOING: {activeWorkout}</p>}
                    <p className="text-zinc-400 text-base mb-4">({eqId})</p>
                    <button onClick={() => handleCheckOut(zone)} className="w-full btn-secondary text-2xl py-2">FINISH WORKOUT</button>
                </div>
            );
        };
        
        const WorkoutSuggestions = ({ workoutLibrary, heatmapData, handleCheckIn, currentCheckIn, completedWorkouts }) => {
            const [selectedGroup, setSelectedGroup] = useState(null);
            
            const getEtaForZone = (zone, data) => {
                // If there's an available machine, wait time is 0.
                if (data.in_use < data.total) {
                    return 0;
                }

                const AVG_SESSION_TIME_BY_ZONE = { treadmill: 20, stair_master: 20, dumbbell_set: 12, bench: 15, squat_rack: 25, back_machine: 18, bicep_machine: 10, tricep_machine: 12, shoulder_machine: 14, quad_machine: 16, glute_machine: 18, leg_machine: 20, chest_machine: 18, cable_station: 15 };
                const avgTime = AVG_SESSION_TIME_BY_ZONE[zone] || 20;

                // If all machines are busy, estimate a wait time (e.g., a fraction of the average time).
                return Math.round(avgTime / 3);
            };

            const suggestions = selectedGroup 
                ? (workoutLibrary[selectedGroup] || [])
                    .filter(item => !completedWorkouts.includes(item.name))
                    .map(item => {
                        const zoneData = heatmapData[item.zone] || { in_use: 0, total: 0 };
                        const eta = getEtaForZone(item.zone, zoneData);
                        const utilPercentage = zoneData.total > 0 ? (zoneData.in_use / zoneData.total) * 100 : 0;
                        return { ...item, util: utilPercentage, eta };
                    }).sort((a, b) => a.eta - b.eta) 
                : [];

            return (
                <div className="card p-6 mt-6">
                    <h3 className="urec-title text-3xl mb-4 urec-gradient-text">WORKOUT PLANNER</h3>
                    <select onChange={(e) => setSelectedGroup(e.target.value)} value={selectedGroup || ""} className="w-full p-3 rounded-md mb-4 input-field">
                        <option value="" disabled>SELECT MUSCLE GROUP...</option>
                        {Object.keys(workoutLibrary).sort().map(group => <option key={group} value={group}>{group}</option>)}
                    </select>

                    {selectedGroup && (
                        <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                            {suggestions.length > 0 ? suggestions.map(s => {
                                const dot = s.util < 30 ? "bg-green-500" : s.util < 70 ? "bg-yellow-500" : "bg-red-500";
                                const isCheckedIn = currentCheckIn && currentCheckIn.zone === s.zone;
                                return (
                                    <div key={`${s.name}-${s.zone}`} className="p-3 rounded-lg bg-zinc-800/80 flex items-center justify-between">
                                        <div>
                                            <p className="font-bold text-2xl">{s.name}</p>
                                            <p className="text-lg text-zinc-300 flex items-center">
                                                <span className={`inline-block w-3 h-3 rounded-full mr-2 border-2 border-zinc-900 ${dot}`}></span>
                                                Wait: ~{s.eta} min
                                            </p>
                                        </div>
                                        <button onClick={() => handleCheckIn(s.zone, s.name)} disabled={isCheckedIn} className="btn-primary py-1 px-4">{isCheckedIn ? 'HERE' : 'GO'}</button>
                                    </div>
                                );
                            }) : <p className="text-center text-zinc-400 font-bold text-xl">ALL DONE FOR THIS MUSCLE GROUP!</p>}
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ user, setPage }) => {
            const [heatmapData, setHeatmapData] = useState({});
            const [currentCheckIn, setCurrentCheckIn] = useState(null);
            const [workoutLibrary, setWorkoutLibrary] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            const [notification, setNotification] = useState({ message: '', type: '' });
            const [completedWorkouts, setCompletedWorkouts] = useState([]);
            const [activeWorkout, setActiveWorkout] = useState(null);

            const handleLogout = () => {
                setCompletedWorkouts([]);
                setActiveWorkout(null);
                setPage('login');
            };

            const fetchData = useCallback(async () => {
                const [heatmapRes, equipmentRes] = await Promise.all([
                    api.get('/analytics/heatmap'),
                    api.get('/equipments')
                ]);
                
                if (heatmapRes && heatmapRes.zones) setHeatmapData(heatmapRes.zones);
                if (equipmentRes) {
                    const userCheckIn = equipmentRes.find(e => e.current_user && e.current_user.toLowerCase() === user.name.toLowerCase() && e.status === 'in_use');
                    setCurrentCheckIn(userCheckIn || null);
                }
            }, [user.name]);
            
            useEffect(() => {
                const loadInitialData = async () => {
                    setIsLoading(true);
                    try {
                        const exercisesRes = await api.get('/exercises/');
                        if (exercisesRes && exercisesRes.exercises) {
                            const library = {};
                            exercisesRes.exercises.forEach(ex => {
                                const muscle = ex.primary_muscle || 'Other';
                                if (!library[muscle]) library[muscle] = [];
                                library[muscle].push({ name: ex.exercise_name, zone: ex.equipment_type });
                            });
                            setWorkoutLibrary(library);
                        }
                        await fetchData();
                    } catch (error) {
                        console.error("Failed to load initial dashboard data:", error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadInitialData();
            }, [fetchData]);

            useEffect(() => {
                const interval = setInterval(fetchData, REFRESH_INTERVAL);
                return () => clearInterval(interval);
            }, [fetchData]);

            const handleCheckIn = async (zone, workoutName) => {
                if (currentCheckIn) {
                    setNotification({ message: `You're already checked in. Check out first.`, type: 'error' });
                    return;
                }
                try {
                    await api.post('/usage_logs/update', { zone, status: 'in_use', user: user.name });
                    if (workoutName) setActiveWorkout(workoutName);
                    setNotification({ message: `Checked into ${zone.replace(/_/g, ' ')}!`, type: 'success' });
                    await fetchData();
                } catch (error) {
                    setNotification({ message: error.message || 'Check-in failed. Zone might be full.', type: 'error' });
                }
            };
            
            const handleCheckOut = async (zone) => {
                const lastActiveWorkout = activeWorkout;
                setCurrentCheckIn(null);
                setActiveWorkout(null);
                if (lastActiveWorkout) setCompletedWorkouts(prev => [...prev, lastActiveWorkout]);
                setNotification({ message: `Checked out from ${zone.replace(/_/g, ' ')}!`, type: 'success' });

                try {
                    await api.post('/usage_logs/update', { zone, status: 'available', user: user.name });
                    await fetchData();
                } catch (error) {
                    setNotification({ message: error.message || 'Check-out failed.', type: 'error' });
                    await fetchData();
                }
            };

            const closeNotification = () => setNotification({ message: '', type: '' });

            return (
                <div className="container mx-auto p-4 md:p-6 min-h-screen">
                    <Notification message={notification.message} type={notification.type} onClose={closeNotification} />
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="urec-title text-7xl font-black urec-gradient-text">UREC Live</h1>
                        <div className="text-right">
                             <p className="font-bold text-2xl">Welcome, {user.name}</p>
                             <button onClick={handleLogout} className="text-xl text-yellow-400 hover:underline">Logout</button>
                        </div>
                    </header>
                    
                    {isLoading ? <Loader /> : (
                         <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="card p-6">
                                    <h3 className="urec-title text-4xl mb-4 urec-gradient-text">LIVE GYM HEATMAP</h3>
                                     <HeatmapGrid heatmapData={heatmapData} onZoneClick={handleCheckIn} currentCheckIn={currentCheckIn} />
                                </div>
                               <div className="card p-6">
                                    <h3 className="urec-title text-4xl mb-4 urec-gradient-text">PEAK HOURS</h3>
                                    <div className="overflow-x-auto chart-scroll-container">
                                        <div className="h-64 w-[1200px] min-w-full">
                                            <HistoricalChart />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <CurrentStatus currentCheckIn={currentCheckIn} handleCheckOut={handleCheckOut} activeWorkout={activeWorkout}/>
                                <WorkoutSuggestions 
                                    workoutLibrary={workoutLibrary} 
                                    heatmapData={heatmapData} 
                                    handleCheckIn={handleCheckIn} 
                                    currentCheckIn={currentCheckIn}
                                    completedWorkouts={completedWorkouts}
                                />
                            </div>
                        </main>
                    )}
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('login');
            const [user, setUser] = useState(null);
            return page === 'login' 
                ? <LoginScreen setPage={setPage} setUser={setUser} />
                : <Dashboard user={user} setPage={setPage} />;
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

